# komparu — Безопасность: лимиты архивов и ресурсов

## Векторы атак

### 1. Классическая zip-бомба

Маленький сжатый файл → огромный распакованный выход.
Пример: 42.zip — 42 КБ сжатый → 4.5 ПБ распакованный.

**Наша защита:** `max_decompressed_size` + `max_compression_ratio`.
Потоковое чтение — память всегда O(chunk_size), но CPU-время растёт с размером распакованных данных.

### 2. Рекурсивная бомба

Архив внутри архива внутри архива. Каждый уровень множит работу декомпрессии.

**Наша защита:** Вложенные архивы **никогда не распаковываются рекурсивно**. Запись-архив сравнивается как бинарный blob. Жёсткое правило, не настраивается.

### 3. Флуд записями

Архив с миллионами крошечных файлов. Убивает время на перечисление и сопоставление путей.

**Наша защита:** `max_archive_entries`.

### 4. Path Traversal

Пути записей вида `../../etc/passwd`. Мы не распаковываем на диск, но пути используются для сопоставления между архивами.

**Наша защита:** Санитизация путей — всегда включена, не настраивается:
- Удаление ведущего `/`
- Разрешение и отклонение компонентов `..`
- Нормализация разделителей к `/`
- Отклонение записей с null-байтами в именах

### 5. Бомба именами записей

Экстремально длинные имена файлов, потребляющие память при сопоставлении путей.

**Наша защита:** `max_entry_name_length`.

### 6. Медленная декомпрессия (алгоритмическая бомба)

Данные формально в рамках лимитов, но максимизируют CPU-время декомпрессии.

**Наша защита:** `comparison_timeout` — лимит реального времени на вызов сравнения.

### 7. Повреждённые/невалидные архивы

Обрезанные заголовки, невалидные контрольные суммы, сломанные потоки.

**Наша защита:** libarchive возвращает ошибки, мы пробрасываем как `ArchiveError` с деталями.

## Настройка лимитов

### Значения по умолчанию — безопасны из коробки

Лимиты **включены по умолчанию** с щедрыми, но безопасными значениями.
Для больших легитимных архивов лимиты поднимаются явно.

```python
komparu.configure(
    # Лимиты архивов
    max_decompressed_size=1 * 1024**3,    # 1 ГБ на архив
    max_compression_ratio=200,             # макс. соотношение распакованный/сжатый
    max_archive_entries=100_000,           # макс. файлов в архиве
    max_entry_name_length=4096,            # макс. длина пути записи (байт)

    # Общие лимиты
    comparison_timeout=300.0,              # 5 мин реального времени на вызов
)
```

### Отключение лимитов

Для доверенных окружений (внутренние инструменты, CI):

```python
komparu.configure(
    max_decompressed_size=None,    # без лимита
    max_compression_ratio=None,    # без лимита
    max_archive_entries=None,      # без лимита
    comparison_timeout=None,       # без лимита
)
```

### Переопределение на вызов

```python
# Это конкретное сравнение допускает большие архивы
result = komparu.compare_archive(
    "huge_backup_a.tar.gz",
    "huge_backup_b.tar.gz",
    max_decompressed_size=50 * 1024**3,   # 50 ГБ для этого вызова
    comparison_timeout=3600.0,             # 1 час
)
```

## Поведение при превышении лимитов

| Лимит | Область | При превышении |
|-------|---------|----------------|
| `max_decompressed_size` | На архив | `ArchiveBombError("decompressed size 1.2 GB exceeds limit 1 GB")` |
| `max_compression_ratio` | На архив, проверяется каждый чанк | `ArchiveBombError("compression ratio 350:1 exceeds limit 200:1")` |
| `max_archive_entries` | На архив | `ArchiveBombError("entry count 150000 exceeds limit 100000")` |
| `max_entry_name_length` | На запись | `ArchiveBombError("entry name 8500 bytes exceeds limit 4096")` |
| `comparison_timeout` | На вызов (wall-clock) | `TimeoutError("comparison exceeded 300s timeout")` |

Все ошибки лимитов — подклассы `ArchiveBombError(ArchiveError)` (кроме timeout).
Сравнение останавливается немедленно. Частичных результатов нет.

## Защита от SSRF

HTTP-редиректы могут быть использованы для доступа к внутренним сервисам.
Сценарий: `https://attacker.com/file` редиректит на `http://localhost:8080/admin`.

**Поведение по умолчанию:** Блокировка редиректов на приватные/внутренние сети:
- `127.0.0.0/8`, `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`
- `::1`, `fe80::/10`
- `localhost`, `*.local`

**Реализация:**
- `CURLOPT_REDIR_PROTOCOLS` — только HTTP/HTTPS (без `file://`, `gopher://` и т.д.)
- Callback редиректа проверяет целевой IP по блоклисту
- Настраивается: `allow_private_redirects=False` (по умолчанию)

```python
# Для внутренних/доверенных сетей где редиректы на приватные IP ожидаемы
komparu.configure(allow_private_redirects=True)
```

## Защита от SIGBUS (mmap)

Если файл обрезан во время memory mapping, доступ за пределами нового размера
вызывает `SIGBUS` — хардварный сигнал, крашащий Python-интерпретатор.

**Реализация:**
- Установка `sigaction` обработчика для `SIGBUS` в C init
- `sigsetjmp`/`siglongjmp` для перехвата и конвертации в `SourceReadError`
- Обработчик per-thread (потокобезопасный)
- Fallback: если SIGBUS-обработка ненадёжна на платформе, используем `read()` вместо `mmap`

## Жёсткие правила (всегда включены, не настраиваются)

| Правило | Обоснование |
|---------|-------------|
| Только потоковое чтение — никогда не пишем на диск | Безопасность памяти |
| Нет рекурсивной распаковки архивов | Предотвращение экспоненциальных бомб |
| Санитизация путей (удаление `..`, ведущего `/`, null-байтов) | Предотвращение путаницы при сопоставлении |
| Память = O(chunk_size) на активное сравнение | Предсказуемое потребление ресурсов |

## Учёт ресурсов

### Пул потоков + архивы

При параллельном сравнении директорий/архивов:
- Каждый воркер держит 2 * chunk_size памяти (два буфера чтения)
- Макс. память воркеров: `max_workers * 2 * chunk_size`
- По умолчанию: 8 * 2 * 64 КБ = 1 МБ — пренебрежимо
- Файловые дескрипторы: ограничены `max_workers` (каждый воркер открывает максимум 2 FD)

### HTTP + архивы

Сравнение удалённых архивов (URL):
- Архив стримится через HTTP Range-запросы
- Распаковка на лету — никогда не скачивается полностью
- Лимиты применяются к распакованному выходу, не к размеру скачивания
- `timeout` (HTTP) и `comparison_timeout` работают независимо

## Иерархия ошибок

```python
class KomparuError(Exception): ...
class ArchiveError(KomparuError): ...           # Общие ошибки архивов
class ArchiveBombError(ArchiveError): ...       # Бомбы/превышение лимитов
class TimeoutError(KomparuError): ...           # Таймаут сравнения
```

## Рекомендации по сценариям

### Публичный API (недоверенный ввод)

```python
komparu.configure(
    max_decompressed_size=100 * 1024**2,   # 100 МБ
    max_compression_ratio=50,
    max_archive_entries=10_000,
    max_entry_name_length=1024,
    comparison_timeout=60.0,
)
```

### Внутренний CI/CD

```python
komparu.configure(
    max_decompressed_size=10 * 1024**3,    # 10 ГБ
    max_compression_ratio=200,
    max_archive_entries=100_000,
    comparison_timeout=600.0,
)
```

### Доверенное окружение

```python
komparu.configure(
    max_decompressed_size=None,
    max_compression_ratio=None,
    max_archive_entries=None,
    comparison_timeout=None,
)
```
