# komparu — План работы

## Фаза 1: Фундамент

**Цель:** Сравнение локальных файлов работает end-to-end.

- [ ] Структура проекта: `meson.build`, `pyproject.toml`
- [ ] C23 ядро: интерфейс `reader.h`, `reader_file.c` (mmap)
- [ ] C23 ядро: `compare.c` — движок чанкового сравнения
- [ ] C23 ядро: `module.c` — CPython-расширение, управление GIL
- [ ] Python sync API: `komparu.compare()` для локальных файлов
- [ ] `compat.h` — макросы версий/платформ
- [ ] Тесты: сравнение локальных файлов (одинаковые, разные, пустые, большие)
- [ ] CI: GitHub Actions, Python 3.12 на Linux

**Результат:** `komparu.compare("/a", "/b")` работает.

## Фаза 2: HTTP-поддержка

**Цель:** Сравнение удалённых URL через Range-запросы.

- [ ] C23 ядро: `reader_http.c` — libcurl, Range-запросы, переиспользование соединений
- [ ] HTTP-опции: заголовки, таймаут, редиректы, SSL
- [ ] Смешанное сравнение: локальный + удалённый
- [ ] Предварительная проверка размера через HEAD / Content-Length
- [ ] Тесты: mock HTTP-сервер (pytest-httpserver), проверка Range
- [ ] Тест ранней остановки: большой удалённый файл, различие в первом чанке

**Результат:** `komparu.compare("/local", "https://remote")` работает.

## Фаза 3: Директории и архивы

**Цель:** Рекурсивное сравнение директорий и архивов.

- [ ] C23 ядро: `dirwalk.c` — рекурсивный обход, относительные пути
- [ ] Python: `compare_dir()` — сравнение директорий
- [ ] C23 ядро: `reader_archive.c` — потоковое чтение через libarchive
- [ ] Python: `compare_archive()` — сравнение архивов
- [ ] Python: `compare_dir_urls()` — директория vs маппинг URL
- [ ] Типы результатов: `DirResult`, `DiffReason`
- [ ] Тесты: директории (вложенные, симлинки, пустые), архивы (zip, tar.gz, смешанные)

**Результат:** `komparu.compare_dir()`, `compare_archive()`, `compare_dir_urls()` работают.

## Фаза 4: Множественное сравнение и параллелизм

**Цель:** Пакетное сравнение с пулом потоков.

- [ ] C23 ядро: `pool.c` — пул потоков, очередь задач
- [ ] Python: `compare_all()`, `compare_many()`, `CompareResult`
- [ ] Параллельное сравнение директорий (пары файлов сравниваются конкурентно)
- [ ] Настраиваемый `max_workers`
- [ ] Тесты: корректность параллелизма, лимиты ресурсов
- [ ] Бенчмарки: параллельно vs последовательно

**Результат:** Мульти-файловое и мульти-директорийное сравнение с параллелизмом.

## Фаза 5: Async API

**Цель:** Нативный async API без обёртки над sync.

- [ ] `komparu/aio.py` — async-версии всех публичных функций
- [ ] Async HTTP через aiohttp
- [ ] Async file I/O через aiofiles
- [ ] C-расширение: `compare_buffers()` для async-пути
- [ ] Тесты: async-эквиваленты всех sync-тестов
- [ ] Тесты: конкурентные async-операции

**Результат:** `await komparu.aio.compare()` и все async-варианты работают.

## Фаза 6: Мульти-версии и Free-Threading

**Цель:** Полная матрица версий Python, free-threaded сборки.

- [ ] CI-матрица: Python 3.12, 3.13, 3.14, main
- [ ] Free-threaded сборки: 3.13t, 3.14t
- [ ] `Py_mod_gil` слот, условная компиляция `Py_GIL_DISABLED`
- [ ] Аудит потокобезопасности C-кода
- [ ] Тестирование JIT-сборки
- [ ] Матрица платформ: Linux, macOS, Windows
- [ ] Конфигурация cibuildwheel для всех вариантов

**Результат:** Все тесты проходят на всех версиях Python и платформах.

## Фаза 7: Релиз

**Цель:** Production-ready релиз на PyPI.

- [ ] README.md (английский), README.ru.md (русский)
- [ ] reST-докстринги на всех публичных элементах API
- [ ] Type stubs / py.typed
- [ ] Набор бенчмарков: локальные, HTTP, параллельные
- [ ] Dockerfile
- [ ] LICENSE (MIT)
- [ ] Workflow публикации на PyPI
- [ ] Релиз v0.1.0

**Результат:** `pip install komparu` работает. Документация готова.
