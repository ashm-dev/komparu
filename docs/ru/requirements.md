# komparu — Техническое задание

## 1. Обзор

Сверхбыстрая библиотека сравнения файлов. Ядро на C23, обёртка для Python.
Сравнивает содержимое локальных файлов, удалённых URL, директорий и архивов.
Чанковая обработка — постоянное потребление памяти вне зависимости от размера файлов.

**Лицензия:** MIT
**Платформы:** Linux, macOS, Windows, Docker
**Python:** 3.12, 3.13, 3.14, main (включая free-threaded сборки)

## 2. Функциональные требования

### FR-1: Попарное сравнение

Побайтовое сравнение двух источников. Возвращает `bool`.

Источники:
- Локальный путь (`/path/to/file`)
- HTTP/HTTPS URL (`https://s3.example.com/file`)

Все комбинации: локальный-локальный, локальный-удалённый, удалённый-удалённый.

### FR-2: Сравнение директорий

Рекурсивное сравнение двух директорий.
Сопоставление файлов по относительному пути.

Результат:
- `equal: bool` — все файлы идентичны
- `diff: dict[str, DiffReason]` — файлы с различным содержимым
- `only_left: set[str]` — файлы только в первой директории
- `only_right: set[str]` — файлы только во второй директории

### FR-3: Сравнение архивов

Сравнение содержимого двух архивов как виртуальных директорий.
Форматы (через libarchive): zip, tar, tar.gz, tar.bz2, tar.xz, 7z, rar.

Тип результата: аналогичен сравнению директорий (FR-2).

### FR-4: Множественное сравнение

Сравнение N источников (файлы, URL, смешанные).

Режимы:
- `compare_all([...]) -> bool` — все идентичны?
- `compare_many([...]) -> CompareResult` — детальная группировка

### FR-5: Директория vs список URL

Сравнение локальной директории с маппингом относительных путей на URL.

```python
komparu.compare_dir_urls(
    "/local/dir",
    {"file1.txt": "https://cdn.example.com/file1.txt", ...}
)
```

### FR-6: Настройка HTTP

Для каждого источника и глобально:
- Пользовательские заголовки (Authorization и т.д.)
- Тело запроса (для POST-based storage API)
- Таймаут
- Политика редиректов
- Отключение проверки SSL

### FR-7: Чанковая обработка

- Настраиваемый размер чанка (по умолчанию: 64 КБ)
- Инкрементальное чтение и сравнение
- Ранняя остановка при первом различии — дальнейший I/O не выполняется

### FR-8: Предварительная проверка размера

Перед сравнением содержимого:
1. Локальные файлы: `stat()` для получения размера
2. Удалённые файлы: `HEAD` запрос / `Content-Length`
3. Несовпадение размеров → мгновенный `False` (настраивается, можно отключить)

### FR-9: Пул потоков

Параллельное сравнение для директорий/множественных сравнений.
- Настраиваемое число воркеров (по умолчанию: `min(cpu_count, 8)`)
- GIL освобождается на время всех C-операций
- Без избыточного потребления ресурсов

### FR-10: Поддержка Free-Threading (3.13t, 3.14t)

- `Py_mod_gil = Py_MOD_GIL_NOT_USED`
- Потокобезопасный C-код: без разделяемого мутабельного глобального состояния
- Атомарные операции где необходимо
- Условная компиляция: `#ifdef Py_GIL_DISABLED`

### FR-11: Совместимость с JIT (3.13+)

Специальная обработка в C-расширении не требуется.
Необходимо тестирование в JIT-сборках для подтверждения отсутствия конфликтов.

### FR-12: Лимиты безопасности архивов

Защита от декомпрессионных бомб и исчерпания ресурсов.
Безопасно из коробки, настраивается per-call или глобально.

Лимиты:
- `max_decompressed_size` — макс. распакованных байт на архив (по умолчанию: 1 ГБ)
- `max_compression_ratio` — макс. соотношение распакованный/сжатый (по умолчанию: 200)
- `max_archive_entries` — макс. файлов в архиве (по умолчанию: 100 000)
- `max_entry_name_length` — макс. длина пути записи (по умолчанию: 4096 байт)
- `comparison_timeout` — реальное время на вызов сравнения (по умолчанию: 300 с) *[планируется — ещё не реализовано в C]*

Жёсткие правила (всегда включены):
- Только потоковое чтение — никогда не распаковываем на диск
- Нет рекурсивной распаковки вложенных архивов
- Санитизация путей (отклонение `..`, ведущего `/`, null-байтов)

Подробности: `docs/ru/security.md`.

## 3. Нефункциональные требования

### NFR-1: Производительность

- Локальное сравнение: скорость близкая к I/O диска
- HTTP сравнение: ограничение только пропускной способностью сети
- Память: O(chunk_size) на активное сравнение, не O(file_size)
- Накладные расходы пула потоков: пренебрежимо малые

### NFR-2: Корректность

- Побайтовое сравнение
- 1 бит различия в файле 1 ТБ → обнаружен, ложных результатов нет
- Без false positive, без false negative

### NFR-3: Качество кода

- Чистый, идиоматичный C23
- Полные reST-докстринги на английском
- Аннотации типов, маркер `py.typed` (PEP 561)
- Покрытие тестами > 90%

### NFR-4: Дистрибуция

- PyPI wheels: manylinux (x86_64, aarch64), macOS (x86_64, arm64), Windows (x86_64)
- Free-threaded wheels (3.13t, 3.14t)
- Source distribution (sdist)
- Docker-образ для CI

### NFR-5: Документация

- README на английском и русском
- Справка по API с примерами
- reST-докстринги на всех публичных элементах API
